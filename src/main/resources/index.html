<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Scale continuum</title>

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    <style>
        input, textarea, select {
            background-color: #FFF;
            color: #337AB7;
        }
    </style>
</head>
<body>

<section class="bg-primary" id="controls">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 text-center">
                <h2 class="section-heading">Scale continuum Demo</h2>
                <p class="text-faded">
                    Please choose the dataset size and the cache configuration.<br/>
                    Then press the 'Start' button to execute the demo. The performance of fetching data will be
                    displayed below
                </p>
                <hr class="light"/>
            </div>
        </div>

        <form name="form" id="form">
            <div class="row">
                <div class="col-md-2"></div>

                <div class="col-md-1">
                    <div style="float:left;padding: 10px;">
                        <div id="taskButton" class="btn btn-primary btn-success">Start</div>
                    </div>
                </div>

                <div class="col-md-1">
                    <label>
                        Dataset size:
                        <select name="datasetCount">
                            <option value="100">100</option>
                            <option value="10000">10000</option>
                            <option value="1000000">1000000</option>
                            <option value="100000000">10000000</option>
                        </select>
                    </label>
                </div>

                <div class="col-md-1">
                    <label>
                        Value size:
                        <select name="valueSize">
                            <option value="100">100 B</option>
                            <option value="1K">1 K8</option>
                            <option value="32K">32 KB</option>
                            <option value="1M">1 MB</option>
                        </select>
                    </label>
                </div>

                <div class="col-md-1">
                    <label>
                        Client count:
                        <input type="text" name="clientCount" value="16"/>
                    </label>
                </div>
                <div class="col-md-2"></div>
            </div>

            <div class="row">
                <div class="col-md-2"></div>

                <!--Enable cache-->
                <div class="col-md-1">
                    <label>
                        Enable cache:
                        <input id="enableCache" type="checkbox" name="cacheEnabled"/>
                    </label>
                </div>

                <!--Heap-->
                <div class="col-md-1">
                    <label id="enableHeapLabel">
                        Enable Heap:
                        <input id="enableHeap" type="checkbox" name="heapEnabled"/>
                    </label>
                </div>

                <div class="col-md-1">
                    <label id="heapSizeLabel">
                        Heap size:
                        <input type="text" name="heapSize" size="6">
                    </label>
                </div>

                <!--Offheap-->
                <div class="col-md-1">
                    <label id="enableOffheapLabel">
                        Enable Offheap:
                        <input id="enableOffheap" type="checkbox" name="offheapEnabled"/>
                    </label>
                </div>

                <div class="col-md-1">
                    <label id="offheapSizeLabel">
                        Offheap size:
                        <input type="text" name="offheapSize" size="6"/>
                    </label>
                </div>

                <!--Terracotta-->
                <div class="col-md-1">
                    <label id="enableTerracottaLabel">
                        Enable Terracotta:
                        <input id="enableTerracotta" type="checkbox" name="enableTerracotta"/>
                    </label>
                </div>

                <div class="col-md-1">
                    <label id="terracottaUrlLabel">
                        Terracotta&nbsp;URL:
                        <input type="text" name="terracottaUrl" size="18"/>
                    </label>
                </div>
            </div>
        </form>
    </div>
</section>

<section id="graphs">
    <div class="container">
        <div class="row">
            <div id="canvasContainer" class="col-lg-12 text-center">
                <canvas id="tps" width="1000" height="350"></canvas>
                <br/>
                <canvas id="latencies" width="1000" height="350"></canvas>
            </div>
        </div>
    </div>
</section>

<script src="js/jquery-3.1.1.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/smoothie.js"></script>
<script type="application/javascript">
    $(document).ready(function () {
        var started = false;
        var intervalFunction;
        var tpsSmoothie;
        var latenciesSmoothie;

//        bind submit button to call Rest start command
        $('#taskButton').click(function () {
            if (started) {
                $.get('/cancel').done(function () {
                            clearInterval(intervalFunction);
                            if (tpsSmoothie !== null) {
                                tpsSmoothie.stop();
                            }
                            if (latenciesSmoothie !== null) {
                                latenciesSmoothie.stop();
                            }
                            $('#taskButton').html('Start');
                            started = false;
                        }
                );
            } else {
                var data = $('form').serializeArray();
                $.post("/start", JSON.stringify(data), "json")
                        .fail(function () {
                            alert("error");
                        })
                        .done(function () {
                            $('#taskButton').html('Stop');
                            started = true;

                            $('#canvasContainer').empty().append('<canvas id="tps" width="1000" height="350"></canvas><br/> <canvas id="latencies" width="1000" height="350"></canvas>');
                            var tpsLine = new TimeSeries();
                            var latenciesLine = new TimeSeries();

                            tpsSmoothie = new SmoothieChart({labels: {fontSize: 20}, millisPerPixel: 64});
                            tpsSmoothie.streamTo(document.getElementById("tps"));

                            latenciesSmoothie = new SmoothieChart({labels: {fontSize: 20}, millisPerPixel: 64});
                            latenciesSmoothie.streamTo(document.getElementById("latencies"));

                            intervalFunction = setInterval(function () {
                                $.get('/stats', function (data) {
                                    $.each(data, function () {
                                        tpsLine.append(this['timestamp'], this['periodicTps']);
                                        latenciesLine.append(this['timestamp'], this['periodicAverageLatencyInMs']);
                                    })
                                })
                            }, 1000);
                            tpsSmoothie.addTimeSeries(tpsLine, {
                                strokeStyle: 'rgba(0, 255, 0, 1)',
                                fillStyle: 'rgba(0, 255, 0, 0.2)',
                                lineWidth: 4
                            }, 1000);
                            latenciesSmoothie.addTimeSeries(latenciesLine, {
                                lineWidth: 5,
                                strokeStyle: '#0055c9',
                                fillStyle: 'rgba(0,0,255,0.30)'
                            }, 1000);
                        });
            }
        });

        $("#enableHeapLabel").hide();
        $("#enableOffheapLabel").hide();
        $("#enableTerracottaLabel").hide();

        $("#heapSizeLabel").hide();
        $("#offheapSizeLabel").hide();
        $("#terracottaUrlLabel").hide();

        $("#enableCache").click(function () {
            $("#enableHeapLabel").toggle();
            $("#enableOffheapLabel").toggle();
            $("#enableTerracottaLabel").toggle();
        });

        $("#enableHeap").click(function () {
            $("#heapSizeLabel").toggle();
        });

        $("#enableOffheap").click(function () {
            $("#offheapSizeLabel").toggle();
        });

        $("#enableTerracotta").click(function () {
            $("#terracottaUrlLabel").toggle();
        });
    })
</script>
</body>
</html>